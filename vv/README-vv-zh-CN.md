# PKUS XNY Ultra — VV（Via 浏览器适配）版本

本说明为“VV（Version Via）”分支/发行版的说明文档。VV 版本在原作者 c-jeremy 的开源项目基础上进行适配与修改，以便在 Via 浏览器环境下获得更好的兼容性与体验。

# 重要声明与致谢

- 本项目基于 c-jeremy 的开源项目 [PKUS XNY Ultra](https://github.com/c-jeremy/pkus-xny-ultra)，感谢原作者与社区贡献。我（fork并修改后）在此基础上继续开源发布，欢迎大家审阅与改进。
- 许可证：与原项目一致（详见仓库 LICENSE，GPLv3）。

# 功能和特点

每项功能均为独立脚本，可根据需要选择安装或在脚本管理页面选择是否开启。

脚本基于v1已有功能/v2功能拆分，也开发了更多功能，经测试在Via和安装篡改猴插件的Edge浏览器上可用。

- 主要功能：路径收藏夹、目录搜索、强制下载pdf、硬刷新、移除界面无用元素、自动收起侧边栏......仍在扩充
- Via优点：
    - 极简风、极小空间占用
    - 支持固定工具栏/点击隐藏工具栏，不会上下滑动（注：展开任务栏那个按钮可以拖动）
    - 原生支持脚本，无需安装插件
    - 主页、菜单、长按菜单等均可定制
    - 支持工具栏色彩模式：让浏览器工具栏和系统任务栏跟随网页颜色
- 脚本改进、优点：
    - 完全兼容Via（废话）
    - 可自行选择是否要更改ui风格
    - 可自行选择想要使用的脚本
    - 按钮位于左侧边栏，自然融入页面，完全不遮挡内容，且只需要点一下
    - 完善可用的路径自动重放功能
    - 支持选择相机拍照上传
    - ...
    - 更多具体功能详见脚本列表
- 不足：
    - 多个功能的脚本需要分别安装（太大单一文件不容易排查兼容性问题）
    - 代码越来越臃肿（都是ai干的）
    - 见todo list吧...

黑白UI修改无兼容性问题且未计划进行修改，可直接使用v1中`ui.user.js`，不再单独提供。

# 脚本列表

| 文件名                          | 描述                                      | 注意                                                                          |
|------------------------------|-----------------------------------------|-----------------------------------------------------------------------------|
| `seamless-login.user.js`     | 无感登录保活。确保成绩显示、自阅等功能总是可用。                | 强烈推荐安装                                                                      |
| `force-download.user.js`     | 让预览PDF组件显示通常被隐藏的下载等按钮。                  | 需要先打开文件。注意word ppt等也只能下载新能源转换后的pdf文件。开启则表示你愿意为所有下载行为负责，并且已经解除了开发者对你下载行为的责任。 |
| `navigation-buttons.user.js` | 提供收藏夹、目录搜索、页面刷新按钮，并在页面加载时自动重放路径。        | 刷新键单击重载页面，长按退出登录。                                                           |
| `del-unused.user.js`         | 自动删除无用页面元素，包括头部“学科素养”、“考试用时”和未提交时的空图片框。 |                                                                             |
| `responsive-sidebar.user.js` | 让侧边栏在屏幕宽度改变时自动收起/展开，并可通过点击最左侧导航条展开。     | 目前阈值为宽度800px。                                                               |
| `image-upload.user.js`       | 在网页实现相机，上传照片时允许选择直接打开相机或从相册上传。          | 如果浏览器支持capture字段（如Edge），则不推荐使用。完成拍照后可使用新能源自带旋转、裁剪工具。                        |

# 如何安装

- Via
    1. 下载并安装Via浏览器：https://viayoo.com/
    2.
        - 打开Via浏览器，访问项目页面，找到需要的脚本文件（`*.user.js`），点击脚本文件中的"Raw"按钮，Via会自动接管安装过程，确认即可完成安装。
        - 或 打开需要的脚本页面并复制脚本内容，在Via浏览器设置 -> 脚本 中点击右上角加号选择"添加脚本"，将脚本粘贴进去并确认。
        - 或 下载需要的脚本文件，在Via的脚本管理页面中点击右上角加号选择"导入脚本"，找到下载的文件导入并确认。
    3. 安装完成后，在Via的脚本管理页面中查看和管理已安装的脚本。
- Edge
    - 见原版 [README-zh-CN.md#如何安装](/README-zh-CN.md#如何安装)
    - 不需要安装`image-upload.user.js`脚本，但推荐安装`handwriting-fix.user.js`脚本以修复窗口上下滑动问题。

# 贡献与反馈

- 本分支在原作者基础上做出适配修改，如有建议或发现问题，欢迎在仓库 Issues 中反馈或提交 PR。
- 若引用本代码或二次发布，请遵循 GPLv3 许可证条款并保留原作者署名与许可证信息。
- 感谢AI工具及提供商，尤其是免费为我提供Copilot教育许可的GitHub，这些工具为我编写陌生语言的代码提供了极大帮助（和添乱）。
- 再次感谢 c-jeremy 及所有开源贡献者！

# todos:

- [x] 实现分离出搜索功能
- [x] 修复搜索按钮有时不出现
- [x] 更新收藏夹按钮图标
- [x] 关于强制刷新和考试成绩不显示的问题：~~等待原作者后续更新~~已实现
- [x] 上传照片时允许选择直接打开相机或从相册上传
- [x] 打开相机后拦截回退
- [x] ~~相机对焦、缩放功能？~~ 不好实现且无必要
- [x] 侧边栏根据屏幕宽度自动收起/展开？~~用ai~~已实现
- [x] 移除未提交的题目上的空“图片”框，放在del-unused中
- [x] 优化删除元素脚本
- [x] 刷新路径提前自动保存；尝试在登出重进后仍能重放路径
- [x] 尝试修复强制刷新按钮自己乱转问题
- [x] 在点击左侧导航栏时展开侧边栏
- [x] ~~添加收藏夹按钮不变小~~ 经测试无法解决
- [x] 同时支持强制刷新和仅页面刷新
- [x] 修复Via上强制刷新无法登出的问题
- [x] 合并4个按钮的插件
- [x] 彻底修复保存路径bug
    - [x] 修复回放路径遇到已打开文件夹时失败的问题（通过先关闭科目）
- [x] 在播放路径后更新最新路径（以供刷新使用）
- [x] 将所有操作按钮移动到页面最左侧并略微减小
    - [x] 测试移除外框仅留白色图标-决定采用
- [x] 在登录界面隐藏按钮
- [x] 在上传照片确认、查看图片、查看解析等页面将按钮置于下层
- [x] 添加ESC关闭收藏夹/搜索框等的功能
- [x] 在页面更改、回退时关闭弹窗
- [x] 相机拍照提高分辨率-稳定性待测试
- [x] 尝试在开始回放时打断正在进行的回放，避免冲突
- [x] 导航按钮复用Drawer统一处理监听器释放问题
- [x] 路径回放自动滚动
- [ ] 测试能否添加相机对焦操作（可行性未知）
- [ ] 测试改用ImageCapture
- [ ] 更新强制刷新图标
- [x] 修复按钮在edge中不固定、可能遮挡导航菜单
- [ ] 修复edge中元素不正确跟随页面

- 计划中：
- [ ] 测试能否保存页面上方标签栏（未成功）
- [ ] 添加快捷键功能（希望获得反馈：用哪些键）
- [ ] 相机添加禁用增强选项（从v2获取实现代码）
- [ ] pdf预览框等添加和查看答案一样的全屏键
  
- 远期：
- [ ] 上方页面导航栏从只能用两侧按键移动改为可滑动：感觉有点难度
- [ ] 修复提交照片后只显示第一张预览（估计比较困难，仅作为可能改进方向）
- [ ] ...
